<!DOCTYPE html>
<html>
<head>
    <title>Galaxy AI Chat</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/sw.js');
    }
    </script>
</head>

<body>

<div class="chat-container">

    <div class="chat-header">
        ðŸŒŒ Room: {{ room }} | ðŸ‘¤ {{ username }}
        <div id="online" style="font-size:12px;margin-top:5px;"></div>
    </div>

    <div class="chat-box" id="chat-box"></div>

    <div id="typing" style="font-size:12px;color:#9d00ff;padding-left:15px;height:20px;"></div>

    <div class="input-box">
        <input id="message" placeholder="Type message..." autocomplete="off">
        <button onclick="sendMessage()">Send</button>
    </div>

</div>

<script>

const socket = io();
const room = "{{ room }}";
const username = "{{ username }}";
const chatBox = document.getElementById("chat-box");
const input = document.getElementById("message");

// Join room
socket.emit("join", {room: room, username: username});

// ========================
// Send Message
// ========================
function sendMessage(){
    const message = input.value.trim();
    if(message === "") return;

    socket.emit("send_message", {
        room: room,
        username: username,
        message: message
    });

    input.value = "";
}

// Send on Enter
input.addEventListener("keypress", function(e){
    if(e.key === "Enter"){
        sendMessage();
    }
});

// ========================
// Auto Scroll
// ========================
function scrollToBottom(){
    chatBox.scrollTop = chatBox.scrollHeight;
}

// ========================
// Receive Message
// ========================
socket.on("message", function(data){

    const div = document.createElement("div");
    div.classList.add("message");

    if(data.username === username){
        div.classList.add("sent");
    } else {
        div.classList.add("received");
    }

    div.innerHTML = "<b>" + data.username + ":</b> " + data.message;
    chatBox.appendChild(div);
    scrollToBottom();
});

// ========================
// Blocked Message
// ========================
socket.on("blocked", function(data){

    const div = document.createElement("div");
    div.classList.add("message", "received");

    div.innerHTML = "<b>System:</b> âš  Message blocked by AI";
    chatBox.appendChild(div);
    scrollToBottom();
});

// ========================
// Typing Indicator
// ========================
input.addEventListener("input", function(){
    socket.emit("typing", {
        room: room,
        username: username
    });
});

socket.on("typing", function(data){
    if(data.username !== username){
        const typingDiv = document.getElementById("typing");
        typingDiv.innerText = data.username + " is typing...";
        setTimeout(() => {
            typingDiv.innerText = "";
        }, 1500);
    }
});

// ========================
// Online Count
// ========================
socket.on("online_count", function(data){
    document.getElementById("online").innerText =
        "ðŸŸ¢ " + data.count + " users online";
});

</script>

</body>
</html>